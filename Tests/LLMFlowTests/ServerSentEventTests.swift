//
//  ServerSentEventTests.swift
//  dify-forward
//
//  Created by AFuture on 2025/4/23.
//

import Testing
@testable import LLMFlow
import AsyncAlgorithms

@Test("testAsyncServerSentEventsInterpreter")
func testAsyncServerSentEventsInterpreter() async throws {
    let lines = [
        "event: response.created\ndata: {\"type\":\"response.created\",\"response\":{\"id\":\"resp_68067c9053e48191bf8a2a0fdf7befa207a7d00106ff247f\",\"object\":\"response\",\"created_at\":1745255568,\"status\":\"in_progress\",\"error\":null,\"incomplete_details\":null,\"instructions\":null,\"max_output_tokens\":null,\"model\":\"gpt-4o-mini-2024-07-18\",\"output\":[],\"parallel_tool_calls\":true,\"previous_response_id\":null,\"reasoning\":{\"effort\":null,\"summary\":null},\"service_tier\":\"auto\",\"store\":true,\"temperature\":1.0,\"text\":{\"format\":{\"type\":\"text\"}},\"tool_choice\":\"auto\",\"tools\":[],\"top_p\":1.0,\"truncation\":\"disabled\",\"usage\":null,\"user\":null,\"metadata\":{}}}\n\n",
        "event: response.in_progress\ndata: {\"type\":\"response.in_progress\",\"response\":{\"id\":\"resp_68067c9053e48191bf8a2a0fdf7befa207a7d00106ff247f\",\"object\":\"response\",\"created_at\":1745255568,\"status\":\"in_progress\",\"error\":null,\"incomplete_details\":null,\"instructions\":null,\"max_output_tokens\":null,\"model\":\"gpt-4o-mini-2024-07-18\",\"output\":[],\"parallel_tool_calls\":true,\"previous_response_id\":null,\"reasoning\":{\"effort\":null,\"summary\":null},\"service_tier\":\"auto\",\"store\":true,\"temperature\":1.0,\"text\":{\"format\":{\"type\":\"text\"}},\"tool_choice\":\"auto\",\"tools\":[],\"top_p\":1.0,\"truncation\":\"disabled\",\"usage\":null,\"user\":null,\"metadata\":{}}}\n\n",
        "event: response.output_item.added\ndata: {\"type\":\"response.output_item.added\",\"output_index\":0,\"item\":{\"id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"type\":\"message\",\"status\":\"in_progress\",\"content\":[],\"role\":\"assistant\"}}\n\nevent: response.content_part.added\ndata: {\"type\":\"response.content_part.added\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"part\":{\"type\":\"output_text\",\"annotations\":[],\"text\":\"\"}}\n\nevent: response.output_text.delta\ndata: {\"type\":\"response.output_text.delta\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"delta\":\"It\"}\n\n",
        "event: response.output_text.delta\ndata: {\"type\":\"response.output_text.delta\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"delta\":\" seems\"}\n\nevent: response.output_text.delta\ndata: {\"type\":\"response.output_text.delta\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"delta\":\" like\"}\n\n",
        "event: response.output_text.delta\ndata: {\"type\":\"response.output_text.delta\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"delta\":\" your\"}\n\nevent: response.output_text.delta\ndata: {\"type\":\"response.output_text.delta\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"delta\":\" message\"}\n\n",
        "event: response.output_text.delta\ndata: {\"type\":\"response.output_text.delta\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"delta\":\" was\"}\n\n",
        "event: response.output_text.delta\ndata: {\"type\":\"response.output_text.delta\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"delta\":\" incomplete\"}\n\n",
        "event: response.output_text.delta\ndata: {\"type\":\"response.output_text.delta\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"delta\":\".\"}\n\n",
        "event: response.output_text.delta\ndata: {\"type\":\"response.output_text.delta\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"delta\":\" How\"}\n\n",
        "event: response.output_text.delta\ndata: {\"type\":\"response.output_text.delta\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"delta\":\" can\"}\n\nevent: response.output_text.delta\ndata: {\"type\":\"response.output_text.delta\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"delta\":\" I\"}\n\n",
        "event: response.output_text.delta\ndata: {\"type\":\"response.output_text.delta\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"delta\":\" assist\"}\n\nevent: response.output_text.delta\ndata: {\"type\":\"response.output_text.delta\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"delta\":\" you\"}\n\n",
        "event: response.output_text.delta\ndata: {\"type\":\"response.output_text.delta\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"delta\":\" today\"}\n\n",
        "event: response.output_text.delta\ndata: {\"type\":\"response.output_text.delta\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"delta\":\"?\"}\n\n",
        "event: response.output_text.done\ndata: {\"type\":\"response.output_text.done\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"text\":\"It seems like your message was incomplete. How can I assist you today?\"}\n\nevent: response.content_part.done\ndata: {\"type\":\"response.content_part.done\",\"item_id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"output_index\":0,\"content_index\":0,\"part\":{\"type\":\"output_text\",\"annotations\":[],\"text\":\"It seems like your message was incomplete. How can I assist you today?\"}}\n\nevent: response.output_item.done\ndata: {\"type\":\"response.output_item.done\",\"output_index\":0,\"item\":{\"id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"type\":\"message\",\"status\":\"completed\",\"content\":[{\"type\":\"output_text\",\"annotations\":[],\"text\":\"It seems like your message was incomplete. How can I assist you today?\"}],\"role\":\"assistant\"}}\n\nevent: response.completed\ndata: {\"type\":\"response.completed\",\"response\":{\"id\":\"resp_68067c9053e48191bf8a2a0fdf7befa207a7d00106ff247f\",\"object\":\"response\",\"created_at\":1745255568,\"status\":\"completed\",\"error\":null,\"incomplete_details\":null,\"instructions\":null,\"max_output_tokens\":null,\"model\":\"gpt-4o-mini-2024-07-18\",\"output\":[{\"id\":\"msg_68067c90b38c8191bc25d94403c5a1ac07a7d00106ff247f\",\"type\":\"message\",\"status\":\"completed\",\"content\":[{\"type\":\"output_text\",\"annotations\":[],\"text\":\"It seems like your message was incomplete. How can I assist you today?\"}],\"role\":\"assistant\"}],\"parallel_tool_calls\":true,\"previous_response_id\":null,\"reasoning\":{\"effort\":null,\"summary\":null},\"service_tier\":\"default\",\"store\":true,\"temperature\":1.0,\"text\":{\"format\":{\"type\":\"text\"}},\"tool_choice\":\"auto\",\"tools\":[],\"top_p\":1.0,\"truncation\":\"disabled\",\"usage\":{\"input_tokens\":8,\"input_tokens_details\":{\"cached_tokens\":0},\"output_tokens\":16,\"output_tokens_details\":{\"reasoning_tokens\":0},\"total_tokens\":24},\"user\":null,\"metadata\":{}}}\n\n",
    ]

    let testData = lines.async.compactMap { $0.data(using: .utf8) }
    
    let interpreter = AsyncServerSentEventsInterpreter(stream: .init(testData))

    for try await event in interpreter {
        print("[*] \(event)")
    }

}
